// +build ignore

package main

import (
	"text/template"

	"sourcegraph.com/sourcegraph/sourcegraph/pkg/gen"
)

func main() {
	svcs := []string{
		"../../../../api/sourcegraph/sourcegraph.pb.go",
		"../../../../vendor/sourcegraph.com/sourcegraph/srclib/store/pb/srcstore.pb.go",
	}
	gen.Generate("outer_middleware.go", tmpl, svcs, nil, "")
}

var tmpl = template.Must(template.New("").Delims("<<<", ">>>").Parse(`// GENERATED CODE - DO NOT EDIT!
// @` + "generated" + `
//
// Generated by:
//
//   go run gen_middleware.go
//
// Called via:
//
//   go generate
//

package outer

import (
	"runtime"

	"golang.org/x/net/context"
	"google.golang.org/grpc"
	"google.golang.org/grpc/codes"
	"sourcegraph.com/sourcegraph/sourcegraph/pkg/vcs"
	"sourcegraph.com/sourcegraph/srclib/store/pb"
	"sourcegraph.com/sqs/pbtypes"
	"sourcegraph.com/sourcegraph/sourcegraph/api/sourcegraph"
	"sourcegraph.com/sourcegraph/sourcegraph/pkg/inventory"
	"sourcegraph.com/sourcegraph/sourcegraph/services/svc"
)

// Services returns a full set of services with an implementation of each service method that lets you customize the initial context.Context and map Go errors to gRPC error codes. It is similar to HTTP handler middleware, but for gRPC servers.
func Services(ctxFunc ContextFunc, services svc.Services) svc.Services {
	s := svc.Services{
		<<<range .>>><<<.Name>>>: wrapped<<<.Name>>>{ctxFunc, services},
		<<<end>>>
	}
	return s
}

<<<range .>>>
	type wrapped<<<.Name>>> struct{
		ctxFunc ContextFunc
		services svc.Services
	}

  <<<$service := .>>>
	<<<range .Methods>>>
		func (s wrapped<<<$service.Name>>>) <<<.Name>>>(ctx context.Context, v1 *<<<.ParamType>>>) (returnedResult *<<<.ResultType>>>, returnedError error) {
			defer func() {
				if err := recover(); err != nil {
					const size = 64 << 10
					buf := make([]byte, size)
					buf = buf[:runtime.Stack(buf, false)]
					returnedError = grpc.Errorf(codes.Internal, "panic in <<<$service.Name>>>.<<<.Name>>>: %v\n\n%s", err, buf)
					returnedResult = nil
				}
			}()

			var err error
			ctx, err = initContext(ctx, s.ctxFunc, s.services)
			if err != nil {
				return nil, wrapErr(err)
			}

			innerSvc := svc.<<<$service.Name>>>OrNil(ctx)
			if innerSvc == nil {
				return nil, grpc.Errorf(codes.Unimplemented, "<<<$service.Name>>>")
			}

			rv, err := innerSvc.<<<.Name>>>(ctx, v1)
			if err != nil {
				return nil, wrapErr(err)
			}

			return rv, nil
		}
	<<<end>>>
<<<end>>>
`))
