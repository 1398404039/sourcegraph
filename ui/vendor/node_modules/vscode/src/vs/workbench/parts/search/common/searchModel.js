/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var timer = require("vs/base/common/timer");
var paths = require("vs/base/common/paths");
var objects = require("vs/base/common/objects");
var strings = require("vs/base/common/strings");
var errors = require("vs/base/common/errors");
var async_1 = require("vs/base/common/async");
var lifecycle_1 = require("vs/base/common/lifecycle");
var map_1 = require("vs/base/common/map");
var set_1 = require("vs/base/common/set");
var event_1 = require("vs/base/common/event");
var search_1 = require("vs/platform/search/common/search");
var replace_1 = require("vs/platform/search/common/replace");
var telemetry_1 = require("vs/platform/telemetry/common/telemetry");
var range_1 = require("vs/editor/common/core/range");
var editorCommon_1 = require("vs/editor/common/editorCommon");
var instantiation_1 = require("vs/platform/instantiation/common/instantiation");
var modelService_1 = require("vs/editor/common/services/modelService");
var replace_2 = require("vs/workbench/parts/search/common/replace");
var rangeDecorations_1 = require("vs/workbench/common/editor/rangeDecorations");
var Match = (function () {
    function Match(_parent, text, lineNumber, offset, length) {
        this._parent = _parent;
        this._lineText = text;
        this._range = new range_1.Range(1 + lineNumber, 1 + offset, 1 + lineNumber, 1 + offset + length);
        this._id = this._parent.id() + '>' + lineNumber + '>' + offset + this.getMatchString();
    }
    Match.prototype.id = function () {
        return this._id;
    };
    Match.prototype.parent = function () {
        return this._parent;
    };
    Match.prototype.text = function () {
        return this._lineText;
    };
    Match.prototype.range = function () {
        return this._range;
    };
    Match.prototype.preview = function () {
        var before = this._lineText.substring(0, this._range.startColumn - 1), inside = this.getMatchString(), after = this._lineText.substring(this._range.endColumn - 1, Math.min(this._range.endColumn + 150, this._lineText.length));
        before = strings.lcut(before, 26);
        return {
            before: before,
            inside: inside,
            after: after,
        };
    };
    Object.defineProperty(Match.prototype, "replaceString", {
        get: function () {
            var searchModel = this.parent().parent().searchModel;
            var matchString = this.getMatchString();
            var replaceString = searchModel.replacePattern.getReplaceString(matchString);
            // If match string is not matching then regex pattern has a lookahead expression
            if (replaceString === null) {
                replaceString = searchModel.replacePattern.getReplaceString(matchString + this._lineText.substring(this._range.endColumn - 1));
            }
            return replaceString;
        },
        enumerable: true,
        configurable: true
    });
    Match.prototype.getMatchString = function () {
        return this._lineText.substring(this._range.startColumn - 1, this._range.endColumn - 1);
    };
    return Match;
}());
exports.Match = Match;
var FileMatch = (function (_super) {
    __extends(FileMatch, _super);
    function FileMatch(_query, _parent, rawMatch, modelService, replaceService) {
        var _this = _super.call(this) || this;
        _this._query = _query;
        _this._parent = _parent;
        _this.rawMatch = rawMatch;
        _this.modelService = modelService;
        _this.replaceService = replaceService;
        _this._onChange = _this._register(new event_1.Emitter());
        _this.onChange = _this._onChange.event;
        _this._onDispose = _this._register(new event_1.Emitter());
        _this.onDispose = _this._onDispose.event;
        _this._modelDecorations = [];
        _this._resource = _this.rawMatch.resource;
        _this._matches = new map_1.LinkedMap();
        _this._removedMatches = new set_1.ArraySet();
        _this._updateScheduler = new async_1.RunOnceScheduler(_this.updateMatchesForModel.bind(_this), 250);
        _this.createMatches();
        _this.registerListeners();
        return _this;
    }
    FileMatch.getDecorationOption = function (selected) {
        return {
            stickiness: editorCommon_1.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,
            className: selected ? 'currentFindMatch' : 'findMatch',
            overviewRuler: {
                color: 'rgba(246, 185, 77, 0.7)',
                darkColor: 'rgba(246, 185, 77, 0.7)',
                position: editorCommon_1.OverviewRulerLane.Center
            }
        };
    };
    FileMatch.prototype.createMatches = function () {
        var _this = this;
        var model = this.modelService.getModel(this._resource);
        if (model) {
            this.bindModel(model);
            this.updateMatchesForModel();
        }
        else {
            this.rawMatch.lineMatches.forEach(function (rawLineMatch) {
                rawLineMatch.offsetAndLengths.forEach(function (offsetAndLength) {
                    var match = new Match(_this, rawLineMatch.preview, rawLineMatch.lineNumber, offsetAndLength[0], offsetAndLength[1]);
                    _this.add(match);
                });
            });
        }
    };
    FileMatch.prototype.registerListeners = function () {
        var _this = this;
        this._register(this.modelService.onModelAdded(function (model) {
            if (model.uri.toString() === _this._resource.toString()) {
                _this.bindModel(model);
            }
        }));
    };
    FileMatch.prototype.bindModel = function (model) {
        var _this = this;
        this._model = model;
        this._modelListener = this._model.onDidChangeContent(function (_) {
            _this._updateScheduler.schedule();
        });
        this._model.onWillDispose(function () { return _this.onModelWillDispose(); });
        this.updateHighlights();
    };
    FileMatch.prototype.onModelWillDispose = function () {
        // Update matches because model might have some dirty changes
        this.updateMatchesForModel();
        this.unbindModel();
    };
    FileMatch.prototype.unbindModel = function () {
        if (this._model) {
            this._updateScheduler.cancel();
            this._model.deltaDecorations(this._modelDecorations, []);
            this._model = null;
            this._modelListener.dispose();
        }
    };
    FileMatch.prototype.updateMatchesForModel = function () {
        // this is called from a timeout and might fire
        // after the model has been disposed
        if (!this._model) {
            return;
        }
        this._matches = new map_1.LinkedMap();
        var matches = this._model
            .findMatches(this._query.pattern, this._model.getFullModelRange(), this._query.isRegExp, this._query.isCaseSensitive, this._query.isWordMatch);
        this.updateMatches(matches);
    };
    FileMatch.prototype.updatesMatchesForLine = function (lineNumber) {
        var _this = this;
        var range = {
            startLineNumber: lineNumber,
            startColumn: this._model.getLineMinColumn(lineNumber),
            endLineNumber: lineNumber,
            endColumn: this._model.getLineMaxColumn(lineNumber)
        };
        var oldMatches = this._matches.values().filter(function (match) { return match.range().startLineNumber === lineNumber; });
        oldMatches.forEach(function (match) { return _this._matches.delete(match.id()); });
        var matches = this._model.findMatches(this._query.pattern, range, this._query.isRegExp, this._query.isCaseSensitive, this._query.isWordMatch);
        this.updateMatches(matches);
    };
    FileMatch.prototype.updateMatches = function (matches) {
        var _this = this;
        matches.forEach(function (range) {
            var match = new Match(_this, _this._model.getLineContent(range.startLineNumber), range.startLineNumber - 1, range.startColumn - 1, range.endColumn - range.startColumn);
            if (!_this._removedMatches.contains(match.id())) {
                _this.add(match);
                if (_this.isMatchSelected(match)) {
                    _this._selectedMatch = match;
                }
            }
        });
        this._onChange.fire(true);
        this.updateHighlights();
    };
    FileMatch.prototype.updateHighlights = function () {
        var _this = this;
        if (!this._model) {
            return;
        }
        if (this.parent().showHighlights) {
            this._modelDecorations = this._model.deltaDecorations(this._modelDecorations, this.matches().map(function (match) { return ({
                range: match.range(),
                options: FileMatch.getDecorationOption(_this.isMatchSelected(match))
            }); }));
        }
        else {
            this._modelDecorations = this._model.deltaDecorations(this._modelDecorations, []);
        }
    };
    FileMatch.prototype.id = function () {
        return this.resource().toString();
    };
    FileMatch.prototype.parent = function () {
        return this._parent;
    };
    FileMatch.prototype.matches = function () {
        return this._matches.values();
    };
    FileMatch.prototype.remove = function (match) {
        this.removeMatch(match);
        this._removedMatches.set(match.id());
        this._onChange.fire(false);
    };
    FileMatch.prototype.replace = function (toReplace) {
        var _this = this;
        return this.replaceService.replace(toReplace)
            .then(function () { return _this.updatesMatchesForLine(toReplace.range().startLineNumber); });
    };
    FileMatch.prototype.setSelectedMatch = function (match) {
        if (match) {
            if (!this._matches.has(match.id())) {
                return;
            }
            if (this.isMatchSelected(match)) {
                return;
            }
        }
        this._selectedMatch = match;
        this.updateHighlights();
    };
    FileMatch.prototype.getSelectedMatch = function () {
        return this._selectedMatch;
    };
    FileMatch.prototype.isMatchSelected = function (match) {
        return this._selectedMatch && this._selectedMatch.id() === match.id();
    };
    FileMatch.prototype.count = function () {
        return this.matches().length;
    };
    FileMatch.prototype.resource = function () {
        return this._resource;
    };
    FileMatch.prototype.name = function () {
        return paths.basename(this.resource().fsPath);
    };
    FileMatch.prototype.add = function (match, trigger) {
        this._matches.set(match.id(), match);
        if (trigger) {
            this._onChange.fire(true);
        }
    };
    FileMatch.prototype.removeMatch = function (match) {
        this._matches.delete(match.id());
        if (this.isMatchSelected(match)) {
            this.setSelectedMatch(null);
        }
        else {
            this.updateHighlights();
        }
    };
    FileMatch.prototype.dispose = function () {
        this.setSelectedMatch(null);
        this.unbindModel();
        this._onDispose.fire();
        _super.prototype.dispose.call(this);
    };
    return FileMatch;
}(lifecycle_1.Disposable));
FileMatch = __decorate([
    __param(3, modelService_1.IModelService), __param(4, replace_2.IReplaceService)
], FileMatch);
exports.FileMatch = FileMatch;
var SearchResult = (function (_super) {
    __extends(SearchResult, _super);
    function SearchResult(_searchModel, replaceService, telemetryService, instantiationService) {
        var _this = _super.call(this) || this;
        _this._searchModel = _searchModel;
        _this.replaceService = replaceService;
        _this.telemetryService = telemetryService;
        _this.instantiationService = instantiationService;
        _this._onChange = _this._register(new event_1.Emitter());
        _this.onChange = _this._onChange.event;
        _this._query = null;
        _this._replacingAll = false;
        _this._fileMatches = new map_1.LinkedMap();
        _this._unDisposedFileMatches = new map_1.LinkedMap();
        _this._rangeHighlightDecorations = _this.instantiationService.createInstance(rangeDecorations_1.RangeHighlightDecorations);
        return _this;
    }
    Object.defineProperty(SearchResult.prototype, "query", {
        set: function (query) {
            this._query = query;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchResult.prototype, "searchModel", {
        get: function () {
            return this._searchModel;
        },
        enumerable: true,
        configurable: true
    });
    SearchResult.prototype.add = function (raw, silent) {
        var _this = this;
        if (silent === void 0) { silent = false; }
        var changed = [];
        raw.forEach(function (rawFileMatch) {
            if (!_this._fileMatches.has(rawFileMatch.resource)) {
                var fileMatch_1 = _this.instantiationService.createInstance(FileMatch, _this._query, _this, rawFileMatch);
                _this.doAdd(fileMatch_1);
                changed.push(fileMatch_1);
                var disposable_1 = fileMatch_1.onChange(function () { return _this.onFileChange(fileMatch_1); });
                fileMatch_1.onDispose(function () { return disposable_1.dispose(); });
            }
        });
        if (!silent) {
            this._onChange.fire({ elements: changed, added: true });
        }
    };
    SearchResult.prototype.clear = function () {
        var changed = this.matches();
        this.disposeMatches();
        this._onChange.fire({ elements: changed, removed: true });
    };
    SearchResult.prototype.remove = function (match) {
        this.doRemove(match);
    };
    SearchResult.prototype.replace = function (match) {
        var _this = this;
        return this.replaceService.replace([match]).then(function () {
            _this.doRemove(match, false, true);
        });
    };
    SearchResult.prototype.replaceAll = function (progressRunner) {
        var _this = this;
        this._replacingAll = true;
        var promise = this.replaceService.replace(this.matches(), progressRunner);
        var onDone = event_1.stopwatch(event_1.fromPromise(promise));
        onDone(function (duration) { return _this.telemetryService.publicLog('replaceAll.started', { duration: duration }); });
        return promise.then(function () {
            _this._replacingAll = false;
            _this.clear();
        }, function () {
            _this._replacingAll = false;
        });
    };
    SearchResult.prototype.matches = function () {
        return this._fileMatches.values();
    };
    SearchResult.prototype.isEmpty = function () {
        return this.fileCount() === 0;
    };
    SearchResult.prototype.fileCount = function () {
        return this._fileMatches.size;
    };
    SearchResult.prototype.count = function () {
        return this.matches().reduce(function (prev, match) { return prev + match.count(); }, 0);
    };
    Object.defineProperty(SearchResult.prototype, "showHighlights", {
        get: function () {
            return this._showHighlights;
        },
        enumerable: true,
        configurable: true
    });
    SearchResult.prototype.toggleHighlights = function (value) {
        if (this._showHighlights === value) {
            return;
        }
        this._showHighlights = value;
        var selectedMatch = null;
        this.matches().forEach(function (fileMatch) {
            fileMatch.updateHighlights();
            if (!selectedMatch) {
                selectedMatch = fileMatch.getSelectedMatch();
            }
        });
        if (this._showHighlights && selectedMatch) {
            this._rangeHighlightDecorations.highlightRange({
                resource: selectedMatch.parent().resource(),
                range: selectedMatch.range()
            });
        }
        else {
            this._rangeHighlightDecorations.removeHighlightRange();
        }
    };
    Object.defineProperty(SearchResult.prototype, "rangeHighlightDecorations", {
        get: function () {
            return this._rangeHighlightDecorations;
        },
        enumerable: true,
        configurable: true
    });
    SearchResult.prototype.onFileChange = function (fileMatch) {
        var added = false;
        var removed = false;
        if (!this._fileMatches.has(fileMatch.resource())) {
            this.doAdd(fileMatch);
            added = true;
        }
        if (fileMatch.count() === 0) {
            this.doRemove(fileMatch, false, false);
            added = false;
            removed = true;
        }
        if (!this._replacingAll) {
            this._onChange.fire({ elements: [fileMatch], added: added, removed: removed });
        }
    };
    SearchResult.prototype.doAdd = function (fileMatch) {
        this._fileMatches.set(fileMatch.resource(), fileMatch);
        if (this._unDisposedFileMatches.has(fileMatch.resource())) {
            this._unDisposedFileMatches.delete(fileMatch.resource());
        }
    };
    SearchResult.prototype.doRemove = function (fileMatch, dispose, trigger) {
        if (dispose === void 0) { dispose = true; }
        if (trigger === void 0) { trigger = true; }
        this._fileMatches.delete(fileMatch.resource());
        if (dispose) {
            fileMatch.dispose();
        }
        else {
            this._unDisposedFileMatches.set(fileMatch.resource(), fileMatch);
        }
        if (trigger) {
            this._onChange.fire({ elements: [fileMatch], removed: true });
        }
    };
    SearchResult.prototype.disposeMatches = function () {
        this._fileMatches.values().forEach(function (fileMatch) { return fileMatch.dispose(); });
        this._unDisposedFileMatches.values().forEach(function (fileMatch) { return fileMatch.dispose(); });
        this._fileMatches.clear();
        this._unDisposedFileMatches.clear();
        this._rangeHighlightDecorations.removeHighlightRange();
    };
    SearchResult.prototype.dispose = function () {
        this.disposeMatches();
        this._rangeHighlightDecorations.dispose();
        _super.prototype.dispose.call(this);
    };
    return SearchResult;
}(lifecycle_1.Disposable));
SearchResult = __decorate([
    __param(1, replace_2.IReplaceService), __param(2, telemetry_1.ITelemetryService),
    __param(3, instantiation_1.IInstantiationService)
], SearchResult);
exports.SearchResult = SearchResult;
var SearchModel = (function (_super) {
    __extends(SearchModel, _super);
    function SearchModel(searchService, telemetryService, instantiationService) {
        var _this = _super.call(this) || this;
        _this.searchService = searchService;
        _this.telemetryService = telemetryService;
        _this.instantiationService = instantiationService;
        _this._searchQuery = null;
        _this._replaceActive = false;
        _this._replaceString = null;
        _this._replacePattern = null;
        _this._searchResult = _this.instantiationService.createInstance(SearchResult, _this);
        return _this;
    }
    SearchModel.prototype.isReplaceActive = function () {
        return this._replaceActive;
    };
    Object.defineProperty(SearchModel.prototype, "replaceActive", {
        set: function (replaceActive) {
            this._replaceActive = replaceActive;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchModel.prototype, "replacePattern", {
        get: function () {
            return this._replacePattern;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchModel.prototype, "replaceString", {
        get: function () {
            return this._replaceString;
        },
        set: function (replaceString) {
            this._replaceString = replaceString;
            if (this._searchQuery) {
                this._replacePattern = new replace_1.ReplacePattern(replaceString, this._searchQuery.contentPattern);
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchModel.prototype, "searchResult", {
        get: function () {
            return this._searchResult;
        },
        enumerable: true,
        configurable: true
    });
    SearchModel.prototype.search = function (query) {
        var _this = this;
        this.cancelSearch();
        this.searchResult.clear();
        this._searchQuery = query;
        this._searchResult.query = this._searchQuery.contentPattern;
        this._replacePattern = new replace_1.ReplacePattern(this._replaceString, this._searchQuery.contentPattern);
        var timerEvent = timer.start(timer.Topic.WORKBENCH, 'Search');
        this.currentRequest = this.searchService.search(this._searchQuery);
        var onDone = event_1.fromPromise(this.currentRequest);
        var onDoneStopwatch = event_1.stopwatch(onDone);
        var start = Date.now();
        onDone(function () { return timerEvent.stop(); });
        onDoneStopwatch(function (duration) { return _this.telemetryService.publicLog('searchResultsFinished', { duration: duration }); });
        var progressEmitter = new event_1.Emitter();
        var onFirstRender = event_1.any(onDone, progressEmitter.event);
        var onFirstRenderStopwatch = event_1.stopwatch(onFirstRender);
        onFirstRenderStopwatch(function (duration) { return _this.telemetryService.publicLog('searchResultsFirstRender', { duration: duration }); });
        this.currentRequest.then(function (value) { return _this.onSearchCompleted(value, Date.now() - start); }, function (e) { return _this.onSearchError(e, Date.now() - start); }, function (p) {
            progressEmitter.fire();
            _this.onSearchProgress(p);
        });
        return this.currentRequest;
    };
    SearchModel.prototype.onSearchCompleted = function (completed, duration) {
        if (completed) {
            this._searchResult.add(completed.results, false);
        }
        var options = objects.assign({}, this._searchQuery.contentPattern);
        delete options.pattern;
        this.telemetryService.publicLog('searchResultsShown', {
            count: this._searchResult.count(),
            fileCount: this._searchResult.fileCount(),
            options: options,
            duration: duration
        });
        return completed;
    };
    SearchModel.prototype.onSearchError = function (e, duration) {
        if (errors.isPromiseCanceledError(e)) {
            this.onSearchCompleted(null, duration);
        }
    };
    SearchModel.prototype.onSearchProgress = function (p) {
        if (p.resource) {
            this._searchResult.add([p], true);
        }
    };
    SearchModel.prototype.cancelSearch = function () {
        if (this.currentRequest) {
            this.currentRequest.cancel();
            this.currentRequest = null;
            return true;
        }
        return false;
    };
    SearchModel.prototype.dispose = function () {
        this.cancelSearch();
        this.searchResult.dispose();
        _super.prototype.dispose.call(this);
    };
    return SearchModel;
}(lifecycle_1.Disposable));
SearchModel = __decorate([
    __param(0, search_1.ISearchService), __param(1, telemetry_1.ITelemetryService), __param(2, instantiation_1.IInstantiationService)
], SearchModel);
exports.SearchModel = SearchModel;
