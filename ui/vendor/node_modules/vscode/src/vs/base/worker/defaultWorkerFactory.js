/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
'use strict';
var platform_1 = require("vs/base/common/platform");
var simpleWorker_1 = require("vs/base/common/worker/simpleWorker");
// Option for hosts to overwrite the worker script url (used in the standalone editor)
var getCrossOriginWorkerScriptUrl = environment('getWorkerUrl', null);
function environment(name, fallback) {
    if (fallback === void 0) { fallback = false; }
    if (platform_1.globals.MonacoEnvironment && platform_1.globals.MonacoEnvironment.hasOwnProperty(name)) {
        return platform_1.globals.MonacoEnvironment[name];
    }
    return fallback;
}
function defaultGetWorkerUrl(workerId, label) {
    // HACK: Disable the web worker, and remove the require call that would
    // otherwise cause Webpack to process it. If we require using worker-loader,
    // it tries to fetch the script from a URL "https://sourcegraph.com/myrepo/-/myfile.go function() { ..."
    // for some reason. This is a bug in Webpack and/or worker-loader. But we
    // can safely disable the web worker without loss of functionality, so
    // we choose that approach instead of debugging it for now.
    throw new Error('web worker disabled; this should be unreachable');
}
var getWorkerUrl = getCrossOriginWorkerScriptUrl || defaultGetWorkerUrl;
/**
 * A worker that uses HTML5 web workers so that is has
 * its own global scope and its own thread.
 */
var WebWorker = (function () {
    function WebWorker(moduleId, id, label, onMessageCallback, onErrorCallback) {
        this.id = id;
        this.worker = new Worker(getWorkerUrl('workerMain.js', label));
        this.postMessage(moduleId);
        this.worker.onmessage = function (ev) {
            onMessageCallback(ev.data);
        };
        if (typeof this.worker.addEventListener === 'function') {
            this.worker.addEventListener('error', onErrorCallback);
        }
    }
    WebWorker.prototype.getId = function () {
        return this.id;
    };
    WebWorker.prototype.postMessage = function (msg) {
        if (this.worker) {
            this.worker.postMessage(msg);
        }
    };
    WebWorker.prototype.dispose = function () {
        this.worker.terminate();
        this.worker = null;
    };
    return WebWorker;
}());
var DefaultWorkerFactory = (function () {
    function DefaultWorkerFactory(label) {
        this._label = label;
        this._webWorkerFailedBeforeError = false;
    }
    DefaultWorkerFactory.prototype.create = function (moduleId, onMessageCallback, onErrorCallback) {
        var _this = this;
        var workerId = (++DefaultWorkerFactory.LAST_WORKER_ID);
        if (this._webWorkerFailedBeforeError) {
            throw this._webWorkerFailedBeforeError;
        }
        return new WebWorker(moduleId, workerId, this._label || 'anonymous' + workerId, onMessageCallback, function (err) {
            simpleWorker_1.logOnceWebWorkerWarning(err);
            _this._webWorkerFailedBeforeError = err;
            onErrorCallback(err);
        });
    };
    return DefaultWorkerFactory;
}());
DefaultWorkerFactory.LAST_WORKER_ID = 0;
exports.DefaultWorkerFactory = DefaultWorkerFactory;
