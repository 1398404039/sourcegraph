{{define "Head"}}<title>Sourcegraph</title>
{{end}}

{{define "Body"}}

<script ignore-csp>
	{{if .Repos}}
		window.repos = JSON.parse({{json .Repos.Repos}}) || [];
	{{end}}
	{{if .RemoteRepos}}
		window.remoteRepos = JSON.parse({{json .RemoteRepos.RemoteRepos}});
	{{end}}
	window.teammates = JSON.parse({{json .Teammates}});

	window.onboarding = {
		linkGitHub: false, // user needs to link GitHub account
		linkGitHubURL: null, // URL for GitHub OAuth
		linkGitHubRedirect: false, // user is beind redirected to the dashboard from GitHub
	};
	{{if .LinkGitHub}}
		window.onboarding.linkGitHub = true;
		window.onboarding.linkGitHubURL = "{{router.URLToGitHubOAuth}}";
	{{else if .GitHubOnboarding}}
		window.onboarding.linkGitHubRedirect = true;
	{{end}}

	{{if .Teammates }}
	if (window.intercomSettings) {
		if (window.teammates && window.teammates.Organizations) {
			window.intercomSettings.companies = window.teammates.Organizations.map(function(company) {
				return {
					id: "github_" + company,
					name: company,
				}
			});
		}
		if (window.teammates && window.teammates.Users) {
			var outstandingInvitations = 0;
			window.teammates.Users.forEach(function(user) {
				if (user.IsInvited) outstandingInvitations += 1;
			});
			window.intercomSettings["outstanding_invites"] = outstandingInvitations;
		}
	}
	{{end}}

	{{if .RemoteRepos}}
	if (window.remoteRepos && window.intercomSettings) {
		var langMap = {};
		var publicCount = 0, privateCount = 0;
		window.remoteRepos.forEach(function(repo) {
			if (repo.Private) {
				privateCount += 1;
			} else {
				publicCount += 1;
			}

			if (!repo.Language) return;
			var lang = repo.Language.replace(/\s/g, "_");
			if (lang === "undefined") return;
			if (langMap[lang]) langMap[lang] += 1;
			if (!langMap[lang]) langMap[lang] = 1;
		});
		window.intercomSettings["repos_public"] = publicCount;
		window.intercomSettings["repos_private"] = privateCount;
		Object.keys(langMap).forEach(function(lang) {
			window.intercomSettings["repos_" + lang] = langMap[lang];
		});
	}
	{{end}}
</script>

<div class="dashboard">
	<div id="DashboardContainer"
		data-react="sourcegraph/dashboard/DashboardContainer"
		data-logo={{assetURL "img/sourcegraph-logo.svg"}}
		data-signupurl={{urlTo "sign-up"}}>
	</div>
</div>

{{end}}
